<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <style>
      body {
        color: #b0b0b0;
        background-color: #1f1f1f;
        display: flex;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        position: absolute;
      }

      main {
        margin: 20px;
        display: flex;
        flex-direction: column;
        flex: 1 1 100%;
      }

      main span {
        position: relative;
        display: flex;
      }

      main span[hidden] {
        display: none;
      }

      main span span {
        margin: 0px 10px;
        flex: 1;
      }

      main span select {
        flex: 2;
      }

      #dsp-switch {
        margin: 20px auto;
      }

      #button-dsp {
        padding: 10px;
      }

      #div-faust-ui {
        flex: 1 1 auto;
        display: flex;
        position: relative;
        flex-direction: column;
        color: black;
      }
    </style>
    <link rel="stylesheet" href="./faust-ui/index.css" />

    <script>
      // Register service worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((registration) => {
              console.log("ServiceWorker registration successful");
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      } else {
      }
    </script>

    <script src="./modules/camera_utils.js" crossorigin="anonymous"></script>
    <script src="./modules/control_utils.js" crossorigin="anonymous"></script>
    <script src="./modules/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="./modules/hands.js" crossorigin="anonymous"></script>
    <script src="./modules/draw_hand_style.js" crossorigin="anonymous"></script>
    <script src="./modules/misc_utils.js" crossorigin="anonymous"></script>
    <script
      src="./modules/hand_faust_params.js"
      crossorigin="anonymous"
    ></script>
    <script src="./modules/modified_utils.js" crossorigin="anonymous"></script>
    <script src="./index.js"></script>
    <script type="module">
      // https://developer.chrome.com/blog/io24-webassembly-webgpu-2

      const attachFaustNode = async () => {
        await faustNode.then((faustNode) => {
          console.log("faustNode", faustNode.setParamValue);
          window.faustNode = faustNode;
          faustNode.setParamValue("/untitled1/gate", 1.0);
        });
      };

      const videoElement = document.getElementsByClassName("input_video")[0];
      const canvasElement = document.getElementsByClassName("output_canvas")[0];

      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
      const canvasCtx = canvasElement.getContext("2d");

      let currentDeviceIndex = 0;
      let videoDevices = [];

      async function switchVideoDevice() {
        if (videoDevices.length === 0) {
          const devices = await navigator.mediaDevices.enumerateDevices();
          videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );
        }
        console.log(videoDevices);

        if (videoDevices.length > 1) {
          currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
          await camera.stop();
          camera.h.facingMode = undefined; // Clear facingMode constraint
          camera.h.deviceId = videoDevices[0].deviceId; // Set new device
          camera.start();
        }
      }
      window.switchVideoDevice = switchVideoDevice;

      videoElement.addEventListener("tap", switchVideoDevice);

      function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // not currently working
        if (camera.h.facingMode === "user") {
          canvasCtx.scale(-1, 1);
          canvasCtx.translate(-canvasElement.width, 0);
        }

        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );

        // console.log("ahhh");

        if (results.multiHandLandmarks) {
          let i = 0;
          if (results.multiHandLandmarks.length === 0) {
            updateFaustParamsNoLandmarks(window.faustNode);
          } else {
            updateFaustParamsForLandmarks(window.faustNode);
            for (const landmarks of results.multiHandLandmarks) {
              drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                color: "#00FF00",
                lineWidth: 1,
              });

              drawSpecificLandmarks(
                canvasCtx,
                landmarks,
                [
                  // LANDMARKS.THUMB_TIP,
                  // LANDMARKS.INDEX_FINGER_TIP,
                  // LANDMARKS.MIDDLE_FINGER_TIP,
                  // LANDMARKS.RING_FINGER_TIP,
                  // LANDMARKS.PINKY_TIP,
                ],
                HAND_STYLES
              );
              updateFaustParams(window.faustNode, landmarks);

              // Display landmark values in top left
              canvasCtx.save();
              canvasCtx.fillStyle = "white";
              canvasCtx.font = "12px monospace";
              canvasCtx.textAlign = "left";

              landmarks.forEach((landmark, index) => {
                const landmarkName =
                  Object.keys(LANDMARKS).find(
                    (key) => LANDMARKS[key] === index
                  ) || "UNKNOWN";
                const text = `${landmarkName}: x=${landmark.x.toFixed(
                  3
                )}, y=${landmark.y.toFixed(3)}, z=${landmark.z.toFixed(3)}`;
                canvasCtx.fillText(text, 10, 60 + index * 15);
              });

              canvasCtx.restore();
            }
          }
        }

        canvasCtx.restore();
      }

      // all taken from https://cdn.jsdelivr.net/npm/@mediapipe/hands

      // needs to find:
      // http://localhost:8080/modules/hand_landmark_full.tflite
      // http://localhost:8080/modules/hands_solution_packed_assets_loader.js
      // http://localhost:8080/modules/hands_solution_simd_wasm_bin.js
      // http://localhost:8080/modules/hands.binarypb

      // https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands_solution_packed_assets.data

      const hands = new Hands({
        locateFile: (file) => {
          return `./modules/hands_files/${file}`;
          // return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        },
      });
      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });
      hands.onResults(onResults);

      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await hands.send({ image: videoElement });
        },
        width: 1280,
        height: 720,
        facingMode: "environment",
      });
      camera.start();
      console.log(camera.h);

      await attachFaustNode();
    </script>
  </head>

  <body style="margin: 0px; padding: 0px; overflow-y: hidden">
    <div class="container">
      <canvas class="output_canvas" width="auto" height="auto"></canvas>
      <video class="input_video" width="200" height="200"></video>
    </div>
    <main>
      <div id="div-faust-ui"></div>
    </main>
  </body>
</html>
